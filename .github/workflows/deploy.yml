# name: Deploy to AWS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20

#       - name: Install dependencies
#         run: npm install

#       - name: Install SST globally
#         run: npm install -g sst@latest

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ap-southeast-1

#       - name: Cleanup invalid SST bootstrap (optional)
#         run: |
#           if aws ssm get-parameter --name "/sst/bootstrap" --region ap-southeast-1 >/dev/null 2>&1; then
#             BOOTSTRAP_DATA=$(aws ssm get-parameter --name "/sst/bootstrap" --query 'Parameter.Value' --output text --region ap-southeast-1)
#             BUCKET_NAME=$(echo "$BOOTSTRAP_DATA" | jq -r '.bucket // empty')
#             if [ -n "$BUCKET_NAME" ] && ! aws s3 ls "s3://$BUCKET_NAME" >/dev/null 2>&1; then
#               aws ssm delete-parameter --name "/sst/bootstrap" --region ap-southeast-1 || true
#             fi
#           fi

#       - name: Deploy with SST
#         env:
#           FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
#           CFTC_APP_TOKEN: ${{ secrets.CFTC_APP_TOKEN }}
#           CFTC_SECRET_TOKEN: ${{ secrets.CFTC_SECRET_TOKEN }}
#           POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
#           EXCEL_IMPORT_PATH: ${{ secrets.EXCEL_IMPORT_PATH }}
#           AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#         run: |
#           sst remove --stage staging --verbose

#       - name: Load Lambda Invoker name
#         id: load_invoker
#         run: |
#           echo "Reading .sst/outputs.json..."
#           if [ ! -f .sst/outputs.json ]; then
#             echo "‚ùå .sst/outputs.json missing!"
#             exit 1
#           fi

#           INVOKER=$(jq -r '.lambda.invokerName // .RunTaskLambda // empty' .sst/outputs.json)
#           if [ -z "$INVOKER" ]; then
#             echo "‚ùå Could not find Lambda Invoker key in outputs.json"
#             jq . .sst/outputs.json
#             exit 1
#           fi

#           echo "INVOKER=$INVOKER" >> $GITHUB_ENV
#           echo "‚úÖ Found Lambda Invoker: $INVOKER"

#       - name: Run Database Migration
#         env:
#           AWS_REGION: ap-southeast-1
#         continue-on-error: true
#         run: |
#           echo "üì¶ Running migration..."
#           aws lambda invoke \
#             --function-name "$INVOKER" \
#             --region $AWS_REGION \
#             --cli-binary-format raw-in-base64-out \
#             --payload '{"action":"migrate"}' \
#             /tmp/migrate.json || true
#           cat /tmp/migrate.json || true

#           if grep -q '"ok":true' /tmp/migrate.json 2>/dev/null; then
#             echo "‚úÖ Migration successful!"
#           else
#             echo "‚ö†Ô∏è Migration failed!"
#           fi
